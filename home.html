<!DOCTYPE html>
<html lang="en">
<head>
    <title>Property Manager</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="css/site.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.0/jquery-ui.min.js" integrity="sha256-eGE6blurk5sHj+rmkfsGYeKyZx3M4bG+ZlFyA7Kns7E=" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="js/app.js"></script>
</head>
<body id="home-body">
        <nav class="navbar navbar-default">
            <div class="container-fluid">
                <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>                        
                </button>
                    <a class="navbar-brand" href="#">Property Manager</a>
                </div>
                <div class="collapse navbar-collapse" id="myNavbar">
                    <ul class="nav navbar-nav">
                        <li><a href="#">Home</a></li>
                        <li><a href="#">Profile</a></li>
                        <li><a href="#">Inbox</a></li>
                        <li><a href="#">Properties</a></li>
                    </ul>
                    <ul class="nav navbar-nav navbar-right">
                        <li>
                        <a href="#">
                            <img class="img-circle" id="profile-thumb" src="images/not-found-icon.png" alt="images/not-found-icon.png"/>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        <div class="loading container-fluid">
            <div class="container-fluid" style="width: 150px;">
                <h3>Loading...</h3>
                <div>
                    <i class="fa fa-circle-o-notch fa-spin loader container-fluid"></i>
                </div>
            </div>
        </div>
        <div class="container-fluid main-content">
            <div id="user-profile">
                    <h3>My Profile</h3><hr>
                    <div>
                        <div class="user-div" id="user-image"></div>
                        <div class="user-div" id="user-name"></div>
                    </div>
                </div>
                <div id="user-properties">
                    <h3>My Properties</h3><hr>
                    <div id="property-content"></div>
                </div>
                <div id="user-inbox">
                    <h3>My Inbox</h3>
                    <button id="msg-modal-btn" class="btn btn-success">New Message</button>
                    <hr>
                    <div>
                        <table id="inbox-sent" class="table">
                            <thead>
                                <tr>
                                    <th scope="col"></th>
                                    <th scope="col">Subject</th>
                                    <th scope="col">From</th>
                                    <th scope="col">Time Sent</th>
                                    <th scope="col">Opened</th>
                                </tr>
                            </thead>
                            <tbody id="inbox-table-body"></tbody>
                        </table>
                        <div id="inbox-received"></div>
                    </div>
                </div>
        </div>
        <!-- Message Modal -->
        <div class="msg-modal">
            <div class="msg-modal-content container-fluid">
                <div class="modal-header">
                    <h3>Send a Message</h3>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <div>
                            <input type="text" id="to-input">
                            <label><b>To</b></label>
                        </div>
                        <div>
                            <input type="text" id="subject-input">
                            <label><b>Subject</b></label>
                        </div>
                        <div>
                            <textarea id="body-input"></textarea>
                        </div>
                        <button id="send-msg-btn" class="btn btn-success">
                            <span class="glyphicon glyphicon-send"></span> Send
                        </button>
                        <button class="btn btn-danger cancel-btn">
                                <span class="glyphicon glyphicon-remove-circle"></span> Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
</body>

<script>
$(document).ready(function(){

    //hide the main content until it's done loading
    $(".main-content").hide();
    $(".loading").show();

    //confirms authentication or redirects the user otherwise
    var u = new User();
    u.authenticate(null, function(user){

        // do the user manipulation in this postback function
        $("#user-image").append('<img class="img img-circle" src="' + user.image_url_main + '" alt="" />');
        $("#user-name").text(user.first_name + " " + user.last_name);

//----- PROPERTY SECTION -----

        var p = new Property();
        p.getPropertyBySession(function (data) {

            //get the properties by session
            data.forEach(function(property){
                $("#property-content").append(
                    '<div class="property-item" ' + 
                        'property_id="' + property.id + '" ' +
                        'property_image="' + property.image_url_main + '" ' +
                        'street="' + property.street_address + '" ' +
                        'city="' + property.city + '" ' +
                        'state="' + property.state + '" ' +
                        'zip="' + property.zip + '" >' +
                        '<img class="img img-circle" src="' + property.image_url_thumbnail + '" alt="" />' +
                    '</div>'
                );

                //property modal
                $(".property-item").click(function () {
                    console.log($(this).attr("street"));
                    $(".msg-modal").show();
                });

            });

//----- INBOX SECTION -----

            //get the user's messages
            var i = new Inbox();
            i.getReceived(function (data) {
                console.log(data);
                data.forEach(function (item) {

                    //debug
                    console.log(item);

                    //set unopened glyph
                    var glyph = '<span class="glyphicon glyphicon-unchecked"></span>';
                    if(item.is_opened == true) {
                        glyph = '<span class="glyphicon glyphicon-check"></span>';
                    }

                    //append the data to the html
                    $("#inbox-table-body").append(
                        '<tr>' +
                            '<td scope="row">' + item.id + '</td>' +
                            '<td>' + item.message.header + '</td>' +
                            '<td>' + item.sender.email + '</td>' +
                            '<td>' + item.message.time_sent + '</td>' +
                            '<td>' + glyph + '</td>' +
                        '</tr>'
                    );
                });

                $(".main-content").show();
                setup();
                $(".loading").hide();

                //send a message to the modal
                $("#send-msg-btn").click(function () {
                    i.send($("#to-input").val(), $("#subject-input").val(), $("#body-input").val(), function (message) {
                        console.log(message);
                        clearMessageModal();
                    });
                    $(this).children().hide();
                    $(this).append('<i class="fa fa-circle-o-notch fa-spin container-fluid"></i>');
                });

                //open the message modal
                $("#msg-modal-btn").click(function () {
                    $(".msg-modal").show();
                });

                //open the message modal
                $(".cancel-btn").click(function () {
                    $(".msg-modal").hide();
                    clearMessageModal();
                });
            });
        });

    });

//----- WINDOW SETUP

    $( window ).resize(function() {
        setup();
    });

    function clearMessageModal(){
        $(".msg-modal").hide();
        $("#to-input").val('');
        $("#subject-input").val('');
        $("#body-input").val('');
        $("#send-msg-btn").children().hide();
        $("#send-msg-btn span").show();
    }

    function setup () {
        //adjust the width of the user property box
        var offset = $("#user-inbox").width() - ($("#user-properties").width() + $("#user-profile").width());
        if(offset > 0){ 
            $("#user-properties").width($("#user-properties").width() + offset - 65);
        }

        //fix the height of the boxes
        $("#user-profile").height($("#user-properties").height());
        $("#user-profile").offset().top = $("#user-properties").offset().top;
    }

});
</script>

</html>